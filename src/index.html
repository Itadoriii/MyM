<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maderas MyM</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://kit.fontawesome.com/43804ad595.js" crossorigin="anonymous"></script>
    <style>
    .holiday-backdrop{
        position:fixed; inset:0; display:none; place-items:center;
        background:rgba(0,0,0,.45); z-index:99999; padding:24px;
        animation: holidayFadeIn .25s ease-out;
    }
    .holiday-backdrop.is-open{ display:grid; }
    .holiday-modal{
        width:min(560px,92vw); background:#fff; border-radius:14px;
        box-shadow:0 20px 60px rgba(0,0,0,.25);
        overflow:hidden; font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }
    .holiday-head{
        display:flex; align-items:center; gap:12px;
        padding:16px 18px;
        background:#ffe8df; /* tono suave */
        border-bottom:1px solid #f2d4c9;
    }
    .holiday-flag{
        width:36px; height:36px; border-radius:10px;
        display:grid; place-items:center; background:#e17055; color:#fff; font-size:20px;
    }
    .holiday-title{ margin:0; font-size:1.15rem; color:#1f2937; font-weight:800; }
    .holiday-body{ padding:18px; color:#374151; line-height:1.5; }
    .holiday-body p{ margin:.35rem 0; }
    .holiday-note{ font-size:.92rem; color:#6b7280; }
    .holiday-actions{
        display:flex; gap:10px; justify-content:flex-end; padding:14px 18px; border-top:1px solid #f3f4f6;
    }
    .holiday-btn{
        border:0; cursor:pointer; padding:10px 14px; border-radius:10px; font-weight:600;
    }
    .holiday-btn.primary{ background:#e17055; color:#fff; }
    .holiday-btn.primary:hover{ filter:brightness(.95); }
    .holiday-btn.ghost{ background:#f3f4f6; color:#111827; }
    .holiday-close{
        margin-left:auto; background:transparent; border:0; font-size:20px; line-height:1; cursor:pointer; color:#6b7280;
    }
    .holiday-close:hover{ color:#111827; }
    .holiday-row{
        display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;
    }
    .holiday-checkbox{ display:flex; align-items:center; gap:8px; color:#4b5563; font-size:.95rem; }
    @keyframes holidayFadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<div id="order-wait" aria-hidden="true">
    <div class="order-wait__box" role="dialog" aria-live="polite">
        <div class="order-wait__spinner"></div>
        <p class="order-wait__title">Generando tu pedidoâ€¦</p>
        <p class="order-wait__text">Por favor, espera un momento.</p>
    </div>
    </div>
<body>

    <div id="holiday-pop" class="holiday-backdrop" role="dialog" aria-modal="true" aria-labelledby="holiday-title">
    <div class="holiday-modal">
        <div class="holiday-head">
        <div class="holiday-flag">ðŸ‡¨ðŸ‡±</div>
        <h3 id="holiday-title" class="holiday-title">Â¡Felices Fiestas Patrias!</h3>
        <button class="holiday-close" aria-label="Cerrar aviso" id="holiday-x">Ã—</button>
        </div>
        <div class="holiday-body">
        <p><strong>No atenderemos del 15 al 22 de septiembre</strong> por Fiestas Patrias.</p>
        <p class="holiday-note">Los pedidos realizados durante este perÃ­odo se procesarÃ¡n a partir del 23 de septiembre.</p>

        <div class="holiday-row" style="margin-top:10px;">
            <label class="holiday-checkbox">
            <input type="checkbox" id="holiday-dontshow">
            No volver a mostrar este aviso
            </label>
        </div>
        </div>
        <div class="holiday-actions">
        <button class="holiday-btn ghost" id="holiday-more">MÃ¡s tarde</button>
        <button class="holiday-btn primary" id="holiday-ok">Entendido</button>
        </div>
    </div>
    </div>
    
    <nav class="menu">
        <section class="menu__container">
            <img src="assets/logo act.png" class="menu__container image">
            <ul class="menu__links">
                <li class="menu__item">
                    <a href="/" class="menu__link">Inicio</a>
                </li>
                <li class="menu__item menu__item--show">
                    <a href="#" class="menu__link ">Productos<img src="assets/arrow.svg" class="menu__arrow"></a>
    
                    <ul class="menu__nesting">
                        <li class="menu__inside" >
                            <a href="#" class="menu__link menu__link--inside category-link" >Pino OregÃ³n Bruto</a>
                        </li>
                        <li class="menu__inside">
                            <a href="#" class="menu__link menu__link--inside category-link ">Pino OregÃ³n Cepillado</a>
                        </li>
                        <li class="menu__inside">
                            <a href="#" class="menu__link menu__link--inside category-link ">Placas metalicas</a>
                        </li>
                        <li class="menu__inside">
                            <a href="#" class="menu__link menu__link--inside category-link">Base</a>
                        </li>
                    </ul>
                </li>
                
                <li class="menu__item">
                    <a href="/aboutus" class="menu__link">Sobre Nosotros</a>
                </li>
                <li class="menu__item">
                    <a href="/login" class="menu__link" id="login-button">
                        <i class="fa-solid fa-user fa-2x"></i>
                    </a>
                </li>
                <!-- Contenedor del carrito -->
               
                <li class="menu__item" id="cart-container">
                    <a href="#" class="menu__link" id="cart-link"></i>Carrito (<span class="cart-count">0</span>)<i class="fa-solid fa-cart-shopping fa-2x"></i></a>
                </li>
                <div id="cartModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h2>Carrito de Compras</h2>
                        <div class="cart-container">
                            <!-- AquÃ­ se mostrarÃ¡n los productos del carrito -->
                        </div>
                        
                        <!-- Nuevos campos agregados -->
                        <div class="delivery-options">
                            <h3>MÃ©todo de entrega</h3>
                            <div class="delivery-option">
                                <input type="radio" id="delivery-shipping" name="delivery" value="envio" checked>
                                <label for="delivery-shipping">EnvÃ­o a domicilio (Indicar direccion en los comentarios, contamos con flete externo de confianza)</label>
                            </div>
                            <div class="delivery-option">
                                <input type="radio" id="delivery-pickup" name="delivery" value="retiro">
                                <label for="delivery-pickup">Retiro en tienda (Sin costo)</label>
                            </div>
                        </div>
                        
                        <div class="cart-comments">
                            <h3>Comentarios</h3>
                            <textarea id="order-comments" placeholder="Â¿AlgÃºn detalle importante para tu pedido? (Opcional)"></textarea>
                        </div>
                        
                        <div class="cart-summary">
                            <h3>Total: $<span id="cart-total">0.00</span></h3>
                        </div>
                        
                        <div class="cart-buttons">
                            <button id="generateOrder" class="cart-action-btn">Generar pedido</button>
                            <button id="clear-cart-btn" class="cart-action-btn">Vaciar carrito</button>
                        </div>
                    </div>
                </div>
                
            </ul>

            <div class="menu__hamburguer">
                <img src="assets/menu.svg" class="menu__img">
            </div>
        </section>

      
    </nav>
    <div id="conteitemcarrusel">
        <div class="itemcarrusel" id="itemc1">
            <div class="tarjetacarrusel" id="ccard1">
                <img src="assets/banner1.png" alt="banner1" class="imgbanner">
            </div>
            <div class="flechascarrusel">
                <a href="#itemc3">
                    <i class="fa-solid fa-circle-arrow-left"></i>
                </a>
                <a href="#itemc2">
                    <i class="fa-solid fa-circle-arrow-right"></i>
                </a>
            </div>
        </div>
        <div class="itemcarrusel" id="itemc2">
            <div class="tarjetacarrusel" id="ccard2">
                <img src="assets/banner2.png" alt="banner1" class="imgbanner">
            </div>
            <div class="flechascarrusel" >
                <a href="#itemc1">
                    <i class="fa-solid fa-circle-arrow-left"></i>
                </a>
                <a href="#itemc3">
                    <i class="fa-solid fa-circle-arrow-right"></i>
                </a>
            </div>
        </div>
        <div class="itemcarrusel" id="itemc3">
            <div class="tarjetacarrusel" id="ccard3">
                <img src="assets/banner3.png" alt="banner1" class="imgbanner">
            </div>
            <div class="flechascarrusel">
                <a href="#itemc2">
                    <i class="fa-solid fa-circle-arrow-left"></i>
                </a>
                <a href="#itemc1">
                    <i class="fa-solid fa-circle-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
    <form id="search-form" class="search-bar">
        <input id="search-input" type="search" name="search" pattern=".*\S.*" required>
        <button class="search-btn" type="submit">
            <img src="assets/lupa.svg" alt="Buscar">
        </button>
    </form>
    <div id="resultq" class="resultadooculto"></div>
    <div class="conteiner" id="conteiner">
        <div class="sidebar">
            <div class="sidebarcate">
                <h2>Categorias</h2>   
            </div>
            <p><a class="category-link">Madera</a></p>
             <!-- Pino OregÃ³n Bruto -->
            <li>
                <a href="#" class="category-link toggle-submenu">Pino OregÃ³n Bruto</a>
                <ul class="submenu">
                <li><a href="/productos?q=Pino OregÃ³n Bruto 2.50">2.50 mts</a></li>
                <li><a href="/productos?q=Pino OregÃ³n Bruto 3.20">3.20 mts</a></li>
                <li><a href="/productos?q=Pino OregÃ³n Bruto 4.00">4.00 mts</a></li>
                <li><a href="/productos?q=Pino OregÃ³n Bruto 5.00">5.00 mts</a></li>
                </ul>
            </li>

            <!-- Pino OregÃ³n Cepillado -->
            <li>
                <a href="#" class="category-link toggle-submenu">Pino OregÃ³n Cepillado</a>
                <ul class="submenu">
                <li><a href="/productos?q=Pino OregÃ³n Cepillado 2.50">2.50 mts</a></li>
                <li><a href="/productos?q=Pino OregÃ³n Cepillado 3.20">3.20 mts</a></li>
                <li><a href="/productos?q=Pino OregÃ³n Cepillado 4.00">4.00 mts</a></li>
                <li><a href="/productos?q=Pino OregÃ³n Cepillado 5.00">5.00 mts</a></li>
                </ul>
            </li>
            <li><a href="#" class="category-link">Roble</a></li>
            <li><a href="#" class="category-link">Cubiertas</a></li>
            <p><a href="#" class="category-link">Bases</a></p>
            <li><a href="#" class="category-link">Base metalica</a></li>
            <li><a href="#" class="category-link">Base de piedra</a></li>
            <p><a href="#" class="category-link">Cielo Elaborado</a></p>
            <p><a href="#" class="category-link">Planchas Osb</a></p>
            <p><a href="#" class="category-link">Polines</a></p>
            <p><a href="#" class="category-link">Protectores y barnÃ­z</a></p>
            <p><a href="#" class="category-link">Terciados</a></p>
            <li><a href="#" class="category-link">Terciado estructural</a></li>
            <li><a href="#" class="category-link">Terciado ranurado</a></li>
            <p><a href="#" class="category-link">Treillage</a></p>
            <p><a href="#">Vitrificante de pisos</a></p>
            <div class="sidebarinfo">
                <a href="/assets/precios.pdf" target="_blank">Listado productos pdf</a>
            </div>




        </div>
        <div class="products-area">
        <div id="catalog-grid" class="catalog-grid"></div>
        <nav id="pager" class="pager"></nav>
        </div>
    </div>
    <div class="featured-products" id="featured-products">
    <h2>Productos Destacados</h2>
    <div class="featured-container"></div> <!-- deja este vacÃ­o -->
    </div> 
    <a href="https://wa.me/56976200646" class="whatsapp-button" target="_blank">
        <i class="fab fa-whatsapp"></i>
    </a>
    <footer class="footer">
        <div class="footer-conteiner">
            <div class="fbox">
                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3329.6852179575494!2d-70.7193986234621!3d-33.43145019654093!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x9662c3f58843e8e9%3A0xa27e1e1dada98bc8!2sMaderas%20MyM!5e0!3m2!1ses-419!2scl!4v1718148865655!5m2!1ses-419!2scl" width="500" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                <ul>
                    <li><h4><i class="fa-solid fa-clock"></i>Nuestros horarios de atenciÃ³n</h4></li>
                    <li>
                        Lunes a jueves de 9:00 a 12:30 hrs y de 14:30 a 17:30 hrs.
                        
                    </li>
                    <li>Viernes de 9:00 a 12:30 hrs y de 14:30 a 16:30 hrs.</li>
                    
 
                </ul>
            </div>
            <div class="fbox">
                <ul>
                    
                
                    <li>
                        <i class="fa-solid fa-location-pin"></i>Av. JosÃ© JoaquÃ­n PÃ©rez 5877
                         
                    </li>
                    <li>
                        <li><i class="fa-solid fa-phone"></i>TÃ©fono:  (FIJO)227743727</li>
                        <li><i class="fa-solid fa-mobile-button"></i>Cel:  +56 9 76200646</li>
                    </li>
                    <li>
                        <i class="fa-solid fa-envelope"></i>
                        Email:  maderas.mym@gmail.com</li>
                    
                </ul>
            </div>
            <div class="fbox" style="padding: 5px;">
                <li><a href="/#">Inicio</a></li>
                    <li><a href="/#">Productos</a></li>
                    <li><a href="/#">Ofertas</a></li>
                    <li><a href="/#">Sobre Nosotros</a></li>
                <hr style="margin-top: 20px; margin-bottom: 20px;">
                <h2>Sigamos en contacto!</h2>
                <div class="red-social">
                    
                    <li>
                        <i class="fa-brands fa-square-instagram fa-2x"></i>
                        <a href="/#">Instagram</a>
                    </li>
                    <li>
                        <i class="fa-brands fa-square-whatsapp fa-2x"></i>
                        <a href="/#">Whatsapp</a>
                    </li>
                </div>
            </div>
        </div>
    </footer>
    <script src="main.js"></script>
    <script>
    /* =========================
    UTILIDADES CARRITO (LS)
    ========================= */
    function getCart(){ try{ return JSON.parse(localStorage.getItem('cart')) || []; }catch{ return []; } }
    function saveCart(cart){ localStorage.setItem('cart', JSON.stringify(cart)); }
    function clearCart(){ saveCart([]); updateCartDisplay(); }
    function addToCart(product){
    const cart = getCart();
    const i = cart.findIndex(p => p.id_producto === product.id_producto);
    if (i !== -1) cart[i].quantity += product.quantity || 1;
    else { product.quantity = product.quantity || 1; cart.push(product); }
    saveCart(cart); updateCartDisplay();
    try{ window.showPopup && showPopup('Producto aÃ±adido al carrito'); }catch{}
    }
    function updateCartDisplay(){
    const cart = getCart();
    const cartContainer   = document.querySelector('.cart-container');
    const cartTotalEl     = document.getElementById('cart-total');
    const cartCountEl     = document.querySelector('.cart-count');
    if (!cartContainer) return;

    cartContainer.innerHTML = '';
    const totalItems = cart.reduce((a,b)=>a + (b.quantity||0), 0);
    if (cartCountEl) cartCountEl.textContent = totalItems;

    if (!cart.length){
        cartContainer.innerHTML = '<p>El carrito estÃ¡ vacÃ­o.</p>';
        if (cartTotalEl) cartTotalEl.textContent = '0.00';
        return;
    }

    let totalPrice = 0;
    cart.forEach((product, idx) => {
        const sub = (Number(product.precio)||0) * (Number(product.quantity)||0);
        totalPrice += sub;
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
        <img src="assets/productos/${product.Linkimg || product.id_producto}.jpg" alt="${product.name}">
        <div class="cart-item-info">
            <h4>${product.name}</h4>
            <p>Precio: $${Number(product.precio).toLocaleString('es-CL')}</p>
            <p>Subtotal: $${sub.toLocaleString('es-CL')}</p>
        </div>
        <div class="cart-quantity">
            <button data-act="minus" data-idx="${idx}">-</button>
            <span>${product.quantity}</span>
            <button data-act="plus" data-idx="${idx}">+</button>
        </div>
        <button class="remove-btn" data-act="rm" data-idx="${idx}">Eliminar</button>
        `;
        cartContainer.appendChild(div);
    });
    cartContainer.onclick = (e)=>{
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        const cart = getCart();
        const idx = Number(btn.dataset.idx);
        const act = btn.dataset.act;
        if (act === 'minus' && cart[idx]) cart[idx].quantity = Math.max(1, (cart[idx].quantity||1)-1);
        if (act === 'plus'  && cart[idx]) cart[idx].quantity = (cart[idx].quantity||1)+1;
        if (act === 'rm') cart.splice(idx,1);
        saveCart(cart); updateCartDisplay();
    };
    if (cartTotalEl) cartTotalEl.textContent = totalPrice.toFixed(2);
    }

    /* =========================
    MODAL CARRITO + OVERLAY
    ========================= */
    const UI = {
    modal:    null,
    wait:     null,
    genBtn:   null,
    placing:  false,
    openModal(e){ if(e) e.preventDefault(); this.modal?.classList.add('is-open'); document.body.style.overflow='hidden'; updateCartDisplay(); },
    closeModal(){ this.modal?.classList.remove('is-open'); document.body.style.overflow=''; },
    openWait(){ this.wait?.classList.add('is-open'); },
    closeWait(){ this.wait?.classList.remove('is-open'); }
    };

    /* =========================
    CATALOGO + DESTACADOS
    ========================= */
   async function loadProductsPage(page = 1, q = '') {
  const GRID  = document.getElementById('catalog-grid');
  const PAGER = document.getElementById('pager');
  const PAGE_SIZE = 6;

  try {
    // 1) Traemos TODOS para paginar solo visibles en el cliente
    const urlAll = new URL('/productos', window.location.origin);
    urlAll.searchParams.set('limit', 10000); // suficiente para cubrir el catÃ¡logo
    if (q) urlAll.searchParams.set('q', q);

    const resAll = await fetch(urlAll);
    if (!resAll.ok) { GRID.innerHTML = '<p>Error cargando productos.</p>'; PAGER.innerHTML = ''; return; }

    const dataAll = await resAll.json();
    const allItems = Array.isArray(dataAll) ? dataAll : (dataAll.productos || []);

    // 2) Filtramos solo visibles (1/true/'1')
    let visibles = allItems.filter(p => p.visible === 1 || p.visible === true || p.visible === '1');
    // 2b) Filtramos por bÃºsqueda
    if (q) {
        const qLower = q.toLowerCase();
        visibles = visibles.filter(p => 
            p.nombre_prod.toLowerCase().includes(qLower) ||
            (p.tipo && p.tipo.toLowerCase().includes(qLower)) ||
            (p.medidas && p.medidas.toLowerCase().includes(qLower))
        );
    }
    // 3) PaginaciÃ³n cliente solo con visibles
    const totalPages = Math.max(1, Math.ceil(visibles.length / PAGE_SIZE));
    const safePage = Math.min(Math.max(1, page), totalPages);
    const start = (safePage - 1) * PAGE_SIZE;
    const pageItems = visibles.slice(start, start + PAGE_SIZE);

    // 4) Render
    renderGrid(pageItems);
    renderPager(safePage, totalPages, q);

  } catch (err) {
    console.error(err);
    GRID.innerHTML = '<p>Error inesperado.</p>';
    PAGER.innerHTML = '';
  }
}

function renderGrid(items){
  const GRID = document.getElementById('catalog-grid');
  if (!items?.length){ GRID.innerHTML = '<p>No hay productos para mostrar.</p>'; return; }
  GRID.innerHTML = items.map(p=>{
      const img = p.ruta || 'assets/placeholder.jpg';
      const precio = Number(p.precio_unidad)||0;
      return `
      <article class="product-card">
        <div class="thumb"><img src="${img}" alt="${p.nombre_prod}"></div>
        <div class="info">
          <h4 class="title" title="${p.nombre_prod}">${p.nombre_prod}</h4>
          <div class="price">$${precio.toLocaleString('es-CL')}</div>
          <div class="meta">
            <div><strong>Tipo:</strong> ${p.tipo || 'â€”'}</div>
            <div><strong>Largo:</strong> ${p.medidas || 'â€”'}</div>
            <div><strong>Dimensiones:</strong> ${p.dimensiones || 'â€”'}</div>
            <div><strong>Stock:</strong> ${p.disponibilidad ?? 'â€”'}</div>
          </div>
          <div class="actions">
            <button class="add-btn"
              data-id="${p.id_producto}"
              data-name="${p.nombre_prod}"
              data-price="${precio}"
              data-img="${p.imagen_url || p.id_producto}">
              Agregar al carrito
            </button>
          </div>
        </div>
      </article>`;
  }).join('');

  GRID.querySelectorAll('.add-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      addToCart({
        id_producto: Number(btn.dataset.id),
        name: btn.dataset.name,
        precio: Number(btn.dataset.price)||0,
        Linkimg: btn.dataset.img,
        quantity: 1
      });
    });
  });
}

function renderPager(page, totalPages, q){
  const PAGER = document.getElementById('pager');
  if (totalPages <= 1){ PAGER.innerHTML=''; return; }

  const btn = (label, goto, disabled=false, active=false)=>`
    <button ${disabled?'disabled':''} class="${active?'active':''}" data-goto="${goto}" type="button">${label}</button>
  `;

  const parts = [];
  parts.push(btn('Â« Anterior', Math.max(1, page-1), page===1));
  const W = 2, start = Math.max(1, page-W), end = Math.min(totalPages, page+W);
  if (start>1){ parts.push(btn('1',1,false,page===1)); if(start>2) parts.push('<span>â€¦</span>'); }
  for(let p=start;p<=end;p++) parts.push(btn(String(p), p, false, p===page));
  if (end<totalPages){ if(end<totalPages-1) parts.push('<span>â€¦</span>'); parts.push(btn(String(totalPages), totalPages, false, page===totalPages)); }
  parts.push(btn('Siguiente Â»', Math.min(totalPages, page+1), page===totalPages));

  PAGER.innerHTML = parts.join('');
  PAGER.querySelectorAll('button[data-goto]').forEach(b=>{
    b.addEventListener('click', ()=> loadProductsPage(Number(b.dataset.goto), q));
  });
}

async function loadFeatured(){
  const WRAP = document.querySelector('.featured-container');
  try{
    const url = new URL('/productos', window.location.origin);
    url.searchParams.set('limit', 10000); // traemos todos para filtrar visibles
    const res = await fetch(url);
    if (!res.ok){ WRAP.innerHTML = '<p>Error cargando destacados.</p>'; return; }

    const data = await res.json();
    const productos = Array.isArray(data) ? data : (data.productos || []);
    const visibles = productos.filter(p => p.visible === 1 || p.visible === true || p.visible === '1');
    const items = visibles.slice(0, 6); // mostramos hasta 8

    WRAP.innerHTML = items.map(p=>{
      const img = p.ruta|| 'assets/placeholder.jpg';
      const precio = Number(p.precio_unidad)||0;
      return `
      <article class="featured-card">
        <div class="thumb"><img src="${img}" alt="${p.nombre_prod}"></div>
        <div class="info">
          <h4 class="title" title="${p.nombre_prod}">${p.nombre_prod}</h4>
          <div class="price">$${precio.toLocaleString('es-CL')}</div>
          <div class="meta">
            <div><strong>Tipo:</strong> ${p.tipo || 'â€”'}</div>
            <div><strong>Largo:</strong> ${p.medidas || 'â€”'}</div>
            <div><strong>Dimensiones:</strong> ${p.dimensiones || 'â€”'}</div>
            <div><strong>Stock:</strong> ${p.disponibilidad ?? 'â€”'}</div>
          </div>
          <div class="actions">
            <button class="add-btn"
              data-id="${p.id_producto}"
              data-name="${p.nombre_prod}"
              data-price="${precio}"
              data-img="${p.imagen_url || p.id_producto}">
              Agregar al carrito
            </button>
          </div>
        </div>
      </article>`;
    }).join('');

    WRAP.querySelectorAll('.add-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        addToCart({
          id_producto: Number(btn.dataset.id),
          name: btn.dataset.name,
          precio: Number(btn.dataset.price)||0,
          Linkimg: btn.dataset.img,
          quantity: 1
        });
      });
    });

  } catch(e){
    console.error(e);
    WRAP.innerHTML = '<p>Error inesperado.</p>';
  }
}

    /* =========================
    GENERAR PEDIDO (con retry si deadlock)
    ========================= */
    async function generateOrder(){
    const cart = getCart();
    if (!cart.length){ alert('Tu carrito estÃ¡ vacÃ­o.'); return; }

    const delivery    = document.querySelector('input[name="delivery"]:checked')?.value || 'envio';
    const comentarios = document.getElementById('order-comments')?.value?.trim() || '';

    // payload que espera el backend
    const payload = cart.map(p => ({
        id_producto: p.id_producto,
        precio: Number(p.precio ?? p.precio_unidad ?? 0),
        quantity: Number(p.quantity ?? 1)
    }));

    const attempts = 3;
    for (let i=1; i<=attempts; i++){
        try{
        const res = await fetch('/api/generar-pedido', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ cart: payload, delivery, comentarios })
        });

        const ct = (res.headers.get('content-type')||'').toLowerCase();
        const raw = await res.text();
        let data = null; if (ct.includes('application/json')){ try{ data = JSON.parse(raw); }catch{} }

        if (!res.ok){
            const msg = (data && (data.error || data.message)) || raw || res.statusText;
            // si fue deadlock, reintentar
            if (/deadlock/i.test(msg) && i < attempts){
            await new Promise(r=>setTimeout(r, 200 + Math.random()*400));
            continue;
            }
            throw new Error(msg);
        }

        // Ã©xito
        clearCart(); updateCartDisplay();
        UI.closeModal();
        alert('Pedido generado exitosamente. Hemos enviado toda la informaciÃ³n a tu correo. Nos contactaremos contigo a la brevedad. Â¡Gracias por su preferencia!');
        return;
        }catch(err){
        if (i === attempts){
            console.error('Error generando pedido:', err);
            alert('No se pudo generar el pedido: ' + (err?.message || 'IntÃ©ntalo nuevamente.'));
        }
        }
    }
    }

    /* =========================
    ARRANQUE
    ========================= */
    document.addEventListener('DOMContentLoaded', ()=>{
    // Referencias UI
    UI.modal  = document.getElementById('cartModal');
    UI.wait   = document.getElementById('order-wait');
    UI.genBtn = document.getElementById('generateOrder');

    // Abrir/Cerrar modal
    const cartLink   = document.getElementById('cart-link');
    const closeBtn   = UI.modal?.querySelector('.close');
    cartLink?.addEventListener('click', (e)=> UI.openModal(e));
    closeBtn?.addEventListener('click', ()=> UI.closeModal());
    UI.modal?.addEventListener('click', (e)=>{ if (e.target === UI.modal) UI.closeModal(); });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && UI.modal?.classList.contains('is-open')) UI.closeModal(); });

    // Botones del carrito
    const clearBtn = document.getElementById('clear-cart-btn');
    clearBtn?.addEventListener('click', (e)=>{ e.preventDefault(); clearCart(); });

    // ÃšNICO listener del botÃ³n â€œGenerar pedidoâ€
    if (UI.genBtn && !UI.genBtn.dataset.bound){
        UI.genBtn.dataset.bound = '1';
        UI.genBtn.addEventListener('click', async (e)=>{
        e.preventDefault();
        if (UI.placing) return;
        UI.placing = true;

        const original = UI.genBtn.textContent;
        UI.genBtn.disabled = true;
        UI.genBtn.textContent = 'Generandoâ€¦';
        UI.openWait();

        try{ await generateOrder(); }
        finally{
            UI.closeWait();
            UI.genBtn.disabled = false;
            UI.genBtn.textContent = original;
            UI.placing = false;
        }
        });
    }

    // BÃºsqueda
    const FORM  = document.getElementById('search-form');
    const INPUT = document.getElementById('search-input');
    FORM?.addEventListener('submit', (e)=>{
        e.preventDefault(); loadProductsPage(1, (INPUT?.value||'').trim());
    });

    //Desplegables side-bar 
    const toggles = document.querySelectorAll('.toggle-submenu');
    toggles.forEach(toggle => {
        toggle.addEventListener('click', (e) => {
            e.preventDefault(); // evita que el enlace principal navegue
            const submenu = toggle.nextElementSibling;
            submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
        });
    });

    // CategorÃ­as principales (sin submenÃºs)
    const categoryLinks = document.querySelectorAll('.category-link:not(.toggle-submenu)');
    categoryLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault(); 
            const query = link.textContent.trim(); 
            loadProductsPage(1, query); 
        });
    });

    // SubmenÃºs (medidas)
    const subMenuLinks = document.querySelectorAll('.submenu a');
    subMenuLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault(); 
            const query = link.textContent.trim(); 
            loadProductsPage(1, query); 
        });
    });


    
    // Cargas iniciales
    loadProductsPage(1);
    loadFeatured();
    updateCartDisplay();
    });
    </script>
    <script>
    (function(){
    const now  = new Date();
    const y    = now.getFullYear();
    const startShow = new Date(`${y}-09-01T00:00:00`);
    const endShow   = new Date(`${y}-09-22T23:59:59`);
    const KEY = `holiday_fiestas_patrias_${y}`;

    // Solo mostrar entre el 1 y el 22 de septiembre y si el usuario no lo desactivÃ³
    if (now >= startShow && now <= endShow && localStorage.getItem(KEY) !== 'hide') {
        const root = document.getElementById('holiday-pop');
        const ok   = document.getElementById('holiday-ok');
        const more = document.getElementById('holiday-more');
        const x    = document.getElementById('holiday-x');
        const dont = document.getElementById('holiday-dontshow');

        const close = (remember=false) => {
        if (remember || dont.checked) localStorage.setItem(KEY, 'hide');
        root.classList.remove('is-open');
        // limpia del DOM para no dejar listeners colgando
        setTimeout(()=> root.remove(), 200);
        };

        ok.addEventListener('click', ()=> close(true));
        more.addEventListener('click', ()=> close(false));
        x.addEventListener('click', ()=> close(false));
        // cerrar al click fuera del cuadro
        root.addEventListener('click', (e)=> { if (e.target === root) close(false); });
        // cerrar con ESC
        document.addEventListener('keydown', (e)=> { if (e.key === 'Escape') close(false); });

        // Â¡Mostrar!
        root.classList.add('is-open');
         
        
    }
    })();
    </script>

    

</body>
</html>

