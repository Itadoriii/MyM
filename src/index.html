<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maderas M&M</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://kit.fontawesome.com/43804ad595.js" crossorigin="anonymous"></script>
</head>
<div id="order-wait" aria-hidden="true">
    <div class="order-wait__box" role="dialog" aria-live="polite">
        <div class="order-wait__spinner"></div>
        <p class="order-wait__title">Generando tu pedido…</p>
        <p class="order-wait__text">Por favor, espera un momento.</p>
    </div>
    </div>
<body>
    
    <nav class="menu">
        <section class="menu__container">
            <img src="assets/logo act.png" class="menu__container image">
            <ul class="menu__links">
                <li class="menu__item">
                    <a href="/" class="menu__link">Inicio</a>
                </li>
                <li class="menu__item menu__item--show">
                    <a href="#" class="menu__link ">Productos<img src="assets/arrow.svg" class="menu__arrow"></a>
    
                    <ul class="menu__nesting">
                        <li class="menu__inside" >
                            <a href="#" class="menu__link menu__link--inside category-link" >Pino oregon</a>
                        </li>
                        <li class="menu__inside">
                            <a href="#" class="menu__link menu__link--inside category-link ">Terciados</a>
                        </li>
                        <li class="menu__inside">
                            <a href="#" class="menu__link menu__link--inside category-link ">Placas metalicas</a>
                        </li>
                        <li class="menu__inside">
                            <a href="#" class="menu__link menu__link--inside category-link">Bases metalicas</a>
                        </li>
                    </ul>
                </li>
                
                <li class="menu__item">
                    <a href="/aboutus" class="menu__link">Sobre Nosotros</a>
                </li>
                <li class="menu__item">
                    <a href="/login" class="menu__link" id="login-button">
                        <img src="assets/Cuenta.png" alt="Cuenta" class="menu__img">
                    </a>
                </li>
                <!-- Contenedor del carrito -->
               
                <li class="menu__item" id="cart-container">
                    <a href="#" class="menu__link" id="cart-link">Carrito (<span class="cart-count">0</span>)</a>
                </li>
                <div id="cartModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h2>Carrito de Compras</h2>
                        <div class="cart-container">
                            <!-- Aquí se mostrarán los productos del carrito -->
                        </div>
                        
                        <!-- Nuevos campos agregados -->
                        <div class="delivery-options">
                            <h3>Método de entrega</h3>
                            <div class="delivery-option">
                                <input type="radio" id="delivery-shipping" name="delivery" value="envio" checked>
                                <label for="delivery-shipping">Envío a domicilio (Indicar direccion en los comentarios)</label>
                            </div>
                            <div class="delivery-option">
                                <input type="radio" id="delivery-pickup" name="delivery" value="retiro">
                                <label for="delivery-pickup">Retiro en tienda (Sin costo)</label>
                            </div>
                        </div>
                        
                        <div class="cart-comments">
                            <h3>Comentarios</h3>
                            <textarea id="order-comments" placeholder="¿Algún detalle importante para tu pedido? (Opcional)"></textarea>
                        </div>
                        
                        <div class="cart-summary">
                            <h3>Total: $<span id="cart-total">0.00</span></h3>
                        </div>
                        
                        <div class="cart-buttons">
                            <button id="generateOrder" class="cart-action-btn">Generar pedido</button>
                            <button id="clear-cart-btn" class="cart-action-btn">Vaciar carrito</button>
                        </div>
                    </div>
                </div>
                
            </ul>

            <div class="menu__hamburguer">
                <img src="assets/menu.svg" class="menu__img">
            </div>
        </section>

      
    </nav>
    <div id="conteitemcarrusel">
        <div class="itemcarrusel" id="itemc1">
            <div class="tarjetacarrusel" id="ccard1">
                <img src="assets/banner1.png" alt="banner1" class="imgbanner">
            </div>
            <div class="flechascarrusel">
                <a href="#itemc3">
                    <i class="fa-solid fa-circle-arrow-left"></i>
                </a>
                <a href="#itemc2">
                    <i class="fa-solid fa-circle-arrow-right"></i>
                </a>
            </div>
        </div>
        <div class="itemcarrusel" id="itemc2">
            <div class="tarjetacarrusel" id="ccard2">
                B
            </div>
            <div class="flechascarrusel" >
                <a href="#itemc1">
                    <i class="fa-solid fa-circle-arrow-left"></i>
                </a>
                <a href="#itemc3">
                    <i class="fa-solid fa-circle-arrow-right"></i>
                </a>
            </div>
        </div>
        <div class="itemcarrusel" id="itemc3">
            <div class="tarjetacarrusel" id="ccard3">
                C
            </div>
            <div class="flechascarrusel">
                <a href="#itemc2">
                    <i class="fa-solid fa-circle-arrow-left"></i>
                </a>
                <a href="#itemc1">
                    <i class="fa-solid fa-circle-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
    <form id="search-form" class="search-bar">
        <input id="search-input" type="search" name="search" pattern=".*\S.*" required>
        <button class="search-btn" type="submit">
            <img src="assets/lupa.svg" alt="Buscar">
        </button>
    </form>
    <div id="resultq" class="resultadooculto"></div>
    <div class="conteiner" id="conteiner">
        <div class="sidebar">
            <div class="sidebarcate">
                <h2>Categorias</h2>   
            </div>
            <p><a class="category-link">Madera</a></p>
            <li><a href="#" class="category-link">Pino oregón de 2,50m</a></li>
            <li><a href="#" class="category-link">Pino oregón de 3,20m</a></li>
            <li><a href="#" class="category-link">Pino oregón de 4m</a></li>
            <li><a href="#" class="category-link">Pino oregon de 5m</a></li>
            <li><a href="#" class="category-link">Pino oregón de 6m</a></li>
            <li><a href="#" class="category-link">Pino oregón de 7m</a></li>
            <li><a href="#" class="category-link">Pino oregón de 8m</a></li>
            <li><a href="#" class="category-link">Pino oregón de 9m</a></li>
            <li><a href="#" class="category-link">Roble</a></li>
            <li><a href="#" class="category-link">Cubiertas</a></li>
            <p><a href="#" class="category-link">Bases</a></p>
            <li><a href="#" class="category-link">Base metalica</a></li>
            <li><a href="#" class="category-link">Base de piedra</a></li>
            <p><a href="#" class="category-link">Cielo Elaborado</a></p>
            <p><a href="#" class="category-link">Planchas Osb</a></p>
            <p><a href="#" class="category-link">Polines</a></p>
            <p><a href="#" class="category-link">Protectores y barníz</a></p>
            <p><a href="#" class="category-link">Terciados</a></p>
            <li><a href="#" class="category-link">Terciado estructural</a></li>
            <li><a href="#" class="category-link">Terciado ranurado</a></li>
            <p><a href="#" class="category-link">Treillage</a></p>
            <p><a href="#">Vitrificante de pisos</a></p>
            <div class="sidebarinfo">
                <h3>Listado productos</h3>
            </div>




        </div>
        <div class="products-area">
        <div id="catalog-grid" class="catalog-grid"></div>
        <nav id="pager" class="pager"></nav>
        </div>
    </div>
    <div class="featured-products" id="featured-products">
    <h2>Productos Destacados</h2>
    <div class="featured-container"></div> <!-- deja este vacío -->
    </div> 
    <a href="https://wa.me/56976200646" class="whatsapp-button" target="_blank">
        <i class="fab fa-whatsapp"></i>
    </a>
    <footer class="footer">
        <div class="footer-conteiner">
            <div class="fbox">
                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3329.6852179575494!2d-70.7193986234621!3d-33.43145019654093!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x9662c3f58843e8e9%3A0xa27e1e1dada98bc8!2sMaderas%20MyM!5e0!3m2!1ses-419!2scl!4v1718148865655!5m2!1ses-419!2scl" width="400" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                <ul>
                    <li>
                        <img src="assets/Pinmap.png" alt="Dirección" class="info-icon">
                         Av. José Joaquín Pérez 5877
                    </li>
                    <li>
                        <img src="assets/tel.png" alt="Teléfono" class="info-icon">
                        Teléfono: (123) 456-7890
                    </li>
                    <li>
                        <img src="assets/mail.png" alt="mail" class="info-icon">
                        Email: contacto@example.com</li>
 
                </ul>
            </div>
            <div class="fbox">
                <ul>
                    <li><a href="/#">Inicio</a></li>
                    <li><a href="/#">Productos</a></li>
                    <li><a href="/#">Ofertas</a></li>
                    <li><a href="/#">Sobre Nosotros</a></li>
                </ul>
            </div>
            <div class="fbox">
                <h2>Sigamos en contacto!</h2>
                <div class="red-social">
                    <li>
                        <img src="assets/FBiconn.png" alt="facebook" class="rrss-icon">
                        <a href="/#">Facebook</a>
                    </li>
                    <li>
                        <img src="assets/IGicon.png" alt="Instagram" class="rrss-icon">
                        <a href="/#">Instagram</a>
                    </li>
                    <li>
                        <img src="assets/WSPicon.png" alt="Whatsapp" class="rrss-icon">
                        <a href="/#">Whatsapp</a>
                    </li>
                </div>
            </div>
        </div>
    </footer>
    <script src="main.js"></script>
    <script>
    /* =========================
    UTILIDADES CARRITO (LS)
    ========================= */
    function getCart(){ try{ return JSON.parse(localStorage.getItem('cart')) || []; }catch{ return []; } }
    function saveCart(cart){ localStorage.setItem('cart', JSON.stringify(cart)); }
    function clearCart(){ saveCart([]); updateCartDisplay(); }
    function addToCart(product){
    const cart = getCart();
    const i = cart.findIndex(p => p.id_producto === product.id_producto);
    if (i !== -1) cart[i].quantity += product.quantity || 1;
    else { product.quantity = product.quantity || 1; cart.push(product); }
    saveCart(cart); updateCartDisplay();
    try{ window.showPopup && showPopup('Producto añadido al carrito'); }catch{}
    }
    function updateCartDisplay(){
    const cart = getCart();
    const cartContainer   = document.querySelector('.cart-container');
    const cartTotalEl     = document.getElementById('cart-total');
    const cartCountEl     = document.querySelector('.cart-count');
    if (!cartContainer) return;

    cartContainer.innerHTML = '';
    const totalItems = cart.reduce((a,b)=>a + (b.quantity||0), 0);
    if (cartCountEl) cartCountEl.textContent = totalItems;

    if (!cart.length){
        cartContainer.innerHTML = '<p>El carrito está vacío.</p>';
        if (cartTotalEl) cartTotalEl.textContent = '0.00';
        return;
    }

    let totalPrice = 0;
    cart.forEach((product, idx) => {
        const sub = (Number(product.precio)||0) * (Number(product.quantity)||0);
        totalPrice += sub;
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
        <img src="assets/productos/${product.Linkimg || product.id_producto}.jpg" alt="${product.name}">
        <div class="cart-item-info">
            <h4>${product.name}</h4>
            <p>Precio: $${Number(product.precio).toLocaleString('es-CL')}</p>
            <p>Subtotal: $${sub.toLocaleString('es-CL')}</p>
        </div>
        <div class="cart-quantity">
            <button data-act="minus" data-idx="${idx}">-</button>
            <span>${product.quantity}</span>
            <button data-act="plus" data-idx="${idx}">+</button>
        </div>
        <button class="remove-btn" data-act="rm" data-idx="${idx}">Eliminar</button>
        `;
        cartContainer.appendChild(div);
    });
    cartContainer.onclick = (e)=>{
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        const cart = getCart();
        const idx = Number(btn.dataset.idx);
        const act = btn.dataset.act;
        if (act === 'minus' && cart[idx]) cart[idx].quantity = Math.max(1, (cart[idx].quantity||1)-1);
        if (act === 'plus'  && cart[idx]) cart[idx].quantity = (cart[idx].quantity||1)+1;
        if (act === 'rm') cart.splice(idx,1);
        saveCart(cart); updateCartDisplay();
    };
    if (cartTotalEl) cartTotalEl.textContent = totalPrice.toFixed(2);
    }

    /* =========================
    MODAL CARRITO + OVERLAY
    ========================= */
    const UI = {
    modal:    null,
    wait:     null,
    genBtn:   null,
    placing:  false,
    openModal(e){ if(e) e.preventDefault(); this.modal?.classList.add('is-open'); document.body.style.overflow='hidden'; updateCartDisplay(); },
    closeModal(){ this.modal?.classList.remove('is-open'); document.body.style.overflow=''; },
    openWait(){ this.wait?.classList.add('is-open'); },
    closeWait(){ this.wait?.classList.remove('is-open'); }
    };

    /* =========================
    CATALOGO + DESTACADOS
    ========================= */
    async function loadProductsPage(page=1, q=''){
    const GRID = document.getElementById('catalog-grid');
    const PAGER = document.getElementById('pager');
    const PAGE_SIZE = 6;
    const url = new URL('https://sebastiancastro.cl/productos', window.location.origin);
    url.searchParams.set('page', page);
    url.searchParams.set('limit', PAGE_SIZE);
    if (q) url.searchParams.set('q', q);
    const res = await fetch(url);
    if (!res.ok){ GRID.innerHTML = '<p>Error cargando productos.</p>'; PAGER.innerHTML = ''; return; }
    const data = await res.json();
    renderGrid(data.productos);
    renderPager(data.page, data.totalPages, q);
    }
    function renderGrid(items){
    const GRID = document.getElementById('catalog-grid');
    if (!items?.length){ GRID.innerHTML = '<p>No hay productos para mostrar.</p>'; return; }
    GRID.innerHTML = items.map(p=>{
        const img = p.imagen_url || 'assets/placeholder.jpg';
        return `
        <article class="product-card">
            <div class="thumb"><img src="${img}" alt="${p.nombre_prod}"></div>
            <div class="info">
            <h4 class="title" title="${p.nombre_prod}">${p.nombre_prod}</h4>
            <div class="price">$${Number(p.precio_unidad).toLocaleString('es-CL')}</div>
            <div class="meta">
                <div><strong>Tipo:</strong> ${p.tipo || '—'}</div>
                <div><strong>Medidas:</strong> ${p.medidas || '—'}</div>
                <div><strong>Dimensiones:</strong> ${p.dimensiones || '—'}</div>
                <div><strong>Stock:</strong> ${p.disponibilidad ?? '—'}</div>
            </div>
            <div class="actions">
                <button class="add-btn" data-id="${p.id_producto}" data-name="${p.nombre_prod}" data-price="${Number(p.precio_unidad)||0}" data-img="${p.imagen_url || p.id_producto}">Agregar al carrito</button>
            </div>
            </div>
        </article>
        `;
    }).join('');
    GRID.querySelectorAll('.add-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
        addToCart({
            id_producto: Number(btn.dataset.id),
            name: btn.dataset.name,
            precio: Number(btn.dataset.price)||0,
            Linkimg: btn.dataset.img,
            quantity: 1
        });
        });
    });
    }
    function renderPager(page, totalPages, q){
    const PAGER = document.getElementById('pager');
    if (totalPages <= 1){ PAGER.innerHTML=''; return; }
    const btn = (label, goto, disabled=false, active=false)=>`
        <button ${disabled?'disabled':''} class="${active?'active':''}" data-goto="${goto}" type="button">${label}</button>
    `;
    const parts = [];
    parts.push(btn('« Anterior', Math.max(1, page-1), page===1));
    const W = 2, start = Math.max(1, page-W), end = Math.min(totalPages, page+W);
    if (start>1){ parts.push(btn('1',1,false,page===1)); if(start>2) parts.push('<span>…</span>'); }
    for(let p=start;p<=end;p++) parts.push(btn(String(p), p, false, p===page));
    if (end<totalPages){ if(end<totalPages-1) parts.push('<span>…</span>'); parts.push(btn(String(totalPages), totalPages, false, page===totalPages)); }
    parts.push(btn('Siguiente »', Math.min(totalPages, page+1), page===totalPages));
    PAGER.innerHTML = parts.join('');
    PAGER.querySelectorAll('button[data-goto]').forEach(b=>{
        b.addEventListener('click', ()=> loadProductsPage(Number(b.dataset.goto), q));
    });
    }
    async function loadFeatured(){
    const WRAP = document.querySelector('.featured-container');
    const url = new URL('https://sebastiancastro.cl/productos', window.location.origin);
    url.searchParams.set('limit', 6);
    const res = await fetch(url);
    if (!res.ok){ WRAP.innerHTML = '<p>Error cargando destacados.</p>'; return; }
    const data = await res.json();
    const productos = Array.isArray(data) ? data : (data.productos || []);
    const items = productos.slice(0,8);
    WRAP.innerHTML = items.map(p=>{
        const img = p.imagen_url || 'assets/placeholder.jpg';
        return `
        <article class="featured-card">
            <div class="thumb"><img src="${img}" alt="${p.nombre_prod}"></div>
            <div class="info">
            <h4 class="title" title="${p.nombre_prod}">${p.nombre_prod}</h4>
            <div class="price">$${Number(p.precio_unidad).toLocaleString('es-CL')}</div>
            <div class="meta">
                <div><strong>Tipo:</strong> ${p.tipo || '—'}</div>
                <div><strong>Medidas:</strong> ${p.medidas || '—'}</div>
                <div><strong>Dimensiones:</strong> ${p.dimensiones || '—'}</div>
                <div><strong>Stock:</strong> ${p.disponibilidad ?? '—'}</div>
            </div>
            <div class="actions">
                <button class="add-btn" data-id="${p.id_producto}" data-name="${p.nombre_prod}" data-price="${Number(p.precio_unidad)||0}" data-img="${p.imagen_url || p.id_producto}">Agregar al carrito</button>
            </div>
            </div>
        </article>
        `;
    }).join('');
    WRAP.querySelectorAll('.add-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
        addToCart({
            id_producto: Number(btn.dataset.id),
            name: btn.dataset.name,
            precio: Number(btn.dataset.price)||0,
            Linkimg: btn.dataset.img,
            quantity: 1
        });
        });
    });
    }

    /* =========================
    GENERAR PEDIDO (con retry si deadlock)
    ========================= */
    async function generateOrder(){
    const cart = getCart();
    if (!cart.length){ alert('Tu carrito está vacío.'); return; }

    const delivery    = document.querySelector('input[name="delivery"]:checked')?.value || 'envio';
    const comentarios = document.getElementById('order-comments')?.value?.trim() || '';

    // payload que espera el backend
    const payload = cart.map(p => ({
        id_producto: p.id_producto,
        precio: Number(p.precio ?? p.precio_unidad ?? 0),
        quantity: Number(p.quantity ?? 1)
    }));

    const attempts = 3;
    for (let i=1; i<=attempts; i++){
        try{
        const res = await fetch('/api/generar-pedido', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ cart: payload, delivery, comentarios })
        });

        const ct = (res.headers.get('content-type')||'').toLowerCase();
        const raw = await res.text();
        let data = null; if (ct.includes('application/json')){ try{ data = JSON.parse(raw); }catch{} }

        if (!res.ok){
            const msg = (data && (data.error || data.message)) || raw || res.statusText;
            // si fue deadlock, reintentar
            if (/deadlock/i.test(msg) && i < attempts){
            await new Promise(r=>setTimeout(r, 200 + Math.random()*400));
            continue;
            }
            throw new Error(msg);
        }

        // éxito
        clearCart(); updateCartDisplay();
        UI.closeModal();
        alert('Pedido generado exitosamente. Hemos enviado toda la información a tu correo. Nos contactaremos contigo a la brevedad. ¡Gracias por su preferencia!');
        return;
        }catch(err){
        if (i === attempts){
            console.error('Error generando pedido:', err);
            alert('No se pudo generar el pedido: ' + (err?.message || 'Inténtalo nuevamente.'));
        }
        }
    }
    }

    /* =========================
    ARRANQUE
    ========================= */
    document.addEventListener('DOMContentLoaded', ()=>{
    // Referencias UI
    UI.modal  = document.getElementById('cartModal');
    UI.wait   = document.getElementById('order-wait');
    UI.genBtn = document.getElementById('generateOrder');

    // Abrir/Cerrar modal
    const cartLink   = document.getElementById('cart-link');
    const closeBtn   = UI.modal?.querySelector('.close');
    cartLink?.addEventListener('click', (e)=> UI.openModal(e));
    closeBtn?.addEventListener('click', ()=> UI.closeModal());
    UI.modal?.addEventListener('click', (e)=>{ if (e.target === UI.modal) UI.closeModal(); });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && UI.modal?.classList.contains('is-open')) UI.closeModal(); });

    // Botones del carrito
    const clearBtn = document.getElementById('clear-cart-btn');
    clearBtn?.addEventListener('click', (e)=>{ e.preventDefault(); clearCart(); });

    // ÚNICO listener del botón “Generar pedido”
    if (UI.genBtn && !UI.genBtn.dataset.bound){
        UI.genBtn.dataset.bound = '1';
        UI.genBtn.addEventListener('click', async (e)=>{
        e.preventDefault();
        if (UI.placing) return;
        UI.placing = true;

        const original = UI.genBtn.textContent;
        UI.genBtn.disabled = true;
        UI.genBtn.textContent = 'Generando…';
        UI.openWait();

        try{ await generateOrder(); }
        finally{
            UI.closeWait();
            UI.genBtn.disabled = false;
            UI.genBtn.textContent = original;
            UI.placing = false;
        }
        });
    }

    // Búsqueda
    const FORM  = document.getElementById('search-form');
    const INPUT = document.getElementById('search-input');
    FORM?.addEventListener('submit', (e)=>{
        e.preventDefault(); loadProductsPage(1, (INPUT?.value||'').trim());
    });

    // Cargas iniciales
    
    loadFeatured();
    loadProductsPage(1);
    updateCartDisplay();
    });
    </script>

    

</body>
</html>

